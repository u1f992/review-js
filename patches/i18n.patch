--- review/i18n.rb	2025-12-18 02:11:39.400789657 +0000
+++ review/i18n.rb	2025-12-18 08:16:18.273325123 +0000
@@ -1,6 +1,6 @@
 # frozen_string_literal: true
 
-require 'yaml'
+require 'nodejs/yaml'
 
 module ReVIEW
   class I18n
@@ -18,19 +18,17 @@
     def self.setup(locale = 'ja', ymlfile = 'locale.yml')
       @i18n = ReVIEW::I18n.new(locale)
 
-      lfile = nil
-      if ymlfile
-        lfile = File.expand_path(ymlfile, Dir.pwd)
-
-        # backward compatibility
-        if !File.exist?(lfile) && (ymlfile == 'locale.yml') && File.exist?(File.expand_path('locale.yaml', Dir.pwd))
-          raise ReVIEW::ConfigError, 'locale.yaml is obsoleted. Please use locale.yml.'
-        end
-      end
-
-      if lfile && File.file?(lfile)
-        @i18n.update_localefile(lfile)
-      end
+      # Opal patch: skip file-based locale loading
+      # lfile = nil
+      # if ymlfile
+      #   lfile = File.expand_path(ymlfile, Dir.pwd)
+      #   if !File.exist?(lfile) && (ymlfile == 'locale.yml') && File.exist?(File.expand_path('locale.yaml', Dir.pwd))
+      #     raise ReVIEW::ConfigError, 'locale.yaml is obsoleted. Please use locale.yml.'
+      #   end
+      # end
+      # if lfile && File.file?(lfile)
+      #   @i18n.update_localefile(lfile)
+      # end
     end
 
     def self.i18n(*_args)
@@ -73,11 +71,108 @@
     end
 
     def load_default
-      load_file(File.expand_path('i18n.yml', File.dirname(__FILE__)))
+      # Opal patch: use hardcoded i18n data instead of file loading
+      @store = default_i18n_data
     end
 
     def load_file(path)
-      @store = YAMLLoader.safe_load_file(path)
+      # Opal patch: file loading not supported, use default data
+      @store ||= default_i18n_data
+    end
+
+    def default_i18n_data
+      {
+        'ja' => {
+          'image' => '図',
+          'table' => '表',
+          'list' => 'リスト',
+          'equation' => '式',
+          'column' => 'コラム「%s」',
+          'columnname' => 'コラム',
+          'column_head' => '■コラム',
+          'part' => '第%pR部',
+          'part_short' => '%pR',
+          'chapter' => '第%d章',
+          'chapter_short' => '%d',
+          'chapter_postfix' => '　',
+          'chapter_quote' => '%s「%s」',
+          'chapter_quote_without_number' => '「%s」',
+          'hd_quote' => '「%s %s」',
+          'hd_quote_without_number' => '「%s」',
+          'appendix' => '付録%pA',
+          'numberless_image' => '図:',
+          'note_head' => 'NOTE',
+          'tip_head' => 'TIP',
+          'info_head' => 'INFORMATION',
+          'warning_head' => 'WARNING',
+          'important_head' => 'IMPORTANT',
+          'caution_head' => 'CAUTION',
+          'notice_head' => 'NOTICE',
+          'memo_head' => 'MEMO',
+          'format_number' => '%s.%d',
+          'format_number_header' => '%s.%d:',
+          'format_number_without_chapter' => '%d',
+          'format_number_header_without_chapter' => '%d:',
+          'image_quote' => '「%s」',
+          'caption_prefix' => ' ',
+          'caption_prefix_idgxml' => '　',
+          'ruby_prefix' => '（',
+          'ruby_postfix' => '）',
+          'external_link' => '%s（%s）',
+          'label_marker' => '●●　',
+          'html_footnote_refmark' => '*%s',
+          'html_footnote_textmark' => '[*%s] ',
+          'html_footnote_backmark' => '⏎',
+          'html_endnote_refmark' => '(%s)',
+          'html_endnote_textmark' => '(%s) ',
+          'toctitle' => '目次'
+        },
+        'en' => {
+          'image' => 'Figure ',
+          'table' => 'Table ',
+          'list' => 'List ',
+          'equation' => 'Equation ',
+          'column' => 'Column %s',
+          'columnname' => 'Column',
+          'column_head' => 'Column',
+          'part' => 'Part %pR',
+          'part_short' => '%pR',
+          'chapter' => 'Chapter %d',
+          'chapter_short' => '%d',
+          'chapter_postfix' => '. ',
+          'chapter_quote' => '%s "%s"',
+          'chapter_quote_without_number' => '"%s"',
+          'hd_quote' => '"%s %s"',
+          'hd_quote_without_number' => '"%s"',
+          'appendix' => 'Appendix %s',
+          'numberless_image' => 'Figure:',
+          'note_head' => 'NOTE',
+          'tip_head' => 'TIP',
+          'info_head' => 'INFORMATION',
+          'warning_head' => 'WARNING',
+          'important_head' => 'IMPORTANT',
+          'caution_head' => 'CAUTION',
+          'notice_head' => 'NOTICE',
+          'memo_head' => 'MEMO',
+          'format_number' => '%s.%d',
+          'format_number_header' => '%s.%d:',
+          'format_number_without_chapter' => '%d',
+          'format_number_header_without_chapter' => '%d:',
+          'image_quote' => '"%s"',
+          'caption_prefix' => ' ',
+          'caption_prefix_idgxml' => '　',
+          'external_link' => '%s (%s)',
+          'ruby_prefix' => '(',
+          'ruby_postfix' => ')',
+          'label_marker' => '●●　',
+          'html_footnote_refmark' => '*%s',
+          'html_footnote_textmark' => '[*%s] ',
+          'html_footnote_backmark' => '⏎',
+          'html_endnote_refmark' => '(%s)',
+          'html_endnote_textmark' => '(%s) ',
+          'toctitle' => 'Table of Contents'
+        }
+      }
     end
 
     def update_localefile(path)
@@ -124,8 +219,9 @@
     end
 
     def t(str, args = nil)
+      # Opal patch: use non-destructive gsub/sub instead of gsub!/sub!
       frmt = @store[@locale][str].dup
-      frmt.gsub!('%%', '##')
+      frmt = frmt.gsub('%%', '##')
 
       unless args.is_a?(Array)
         args = args.nil? && frmt !~ /%/ ? [] : [args]
@@ -136,34 +232,34 @@
       percents.each_with_index do |i, idx|
         case i
         when '%pA'
-          frmt.sub!(i, ALPHA_U[args[idx]])
+          frmt = frmt.sub(i, ALPHA_U[args[idx]])
           remove_args << idx
         when '%pa'
-          frmt.sub!(i, ALPHA_L[args[idx]])
+          frmt = frmt.sub(i, ALPHA_L[args[idx]])
           remove_args << idx
         when '%pAW'
-          frmt.sub!(i, ALPHA_UW[args[idx]])
+          frmt = frmt.sub(i, ALPHA_UW[args[idx]])
           remove_args << idx
         when '%paW'
-          frmt.sub!(i, ALPHA_LW[args[idx]])
+          frmt = frmt.sub(i, ALPHA_LW[args[idx]])
           remove_args << idx
         when '%pR'
-          frmt.sub!(i, ROMAN_U[args[idx]])
+          frmt = frmt.sub(i, ROMAN_U[args[idx]])
           remove_args << idx
         when '%pr'
-          frmt.sub!(i, ROMAN_L[args[idx]])
+          frmt = frmt.sub(i, ROMAN_L[args[idx]])
           remove_args << idx
         when '%pRW'
-          frmt.sub!(i, ROMAN_UW[args[idx]])
+          frmt = frmt.sub(i, ROMAN_UW[args[idx]])
           remove_args << idx
         when '%pJ'
-          frmt.sub!(i, JAPAN[args[idx]])
+          frmt = frmt.sub(i, JAPAN[args[idx]])
           remove_args << idx
         when '%pdW'
-          frmt.sub!(i, ARABIC_LW[args[idx]])
+          frmt = frmt.sub(i, ARABIC_LW[args[idx]])
           remove_args << idx
         when '%pDW'
-          frmt.sub!(i, ARABIC_UW[args[idx]])
+          frmt = frmt.sub(i, ARABIC_UW[args[idx]])
           remove_args << idx
         end
       end
@@ -171,7 +267,7 @@
         args.delete_at(idx)
       end
       args_matched = (frmt.count('%') <= args.size)
-      frmt.gsub!('##', '%%')
+      frmt = frmt.gsub('##', '%%')
       args_matched ? (frmt % args) : frmt
     rescue StandardError
       str
